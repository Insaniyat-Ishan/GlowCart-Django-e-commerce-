{% extends "base.html" %}
{% load shop_extras %}
{% block title %}Order #{{ order.id }} — GlowCart{% endblock %}
{% block content %}
<div class="container">
  <h1 class="h4 mb-3">Order #{{ order.id }}</h1>
  <p class="text-muted">Status: <strong class="text-dark">{{ order.get_status_display }}</strong></p>

  <div class="card p-3 mb-3">
    <h2 class="h6">Items</h2>
    <ul class="list-group list-group-flush">
      {% for it in order.items.all %}
      <li class="list-group-item d-flex justify-content-between">
        <div>{{ it.product.title }} <span class="text-muted">× {{ it.qty }}</span></div>
        <div>{{ it.unit_price|money }}</div>
      </li>
      {% endfor %}
    </ul>
  </div>

  <div class="card p-3">
    <div class="d-flex justify-content-between">
      <span>Subtotal</span><span>{{ order.subtotal|money }}</span>
    </div>
    {% if order.discount_total and order.discount_total > 0 %}
      <div class="d-flex justify-content-between text-success">
        <span>Discount{% if order.coupon_code %} ({{ order.coupon_code }}){% endif %}</span>
        <span>-{{ order.discount_total|money }}</span>
      </div>
    {% endif %}
    <div class="d-flex justify-content-between">
      <span>Shipping{% if order.shipping_method %} ({{ order.shipping_method.name }}){% endif %}</span>
      <span>{{ order.shipping_cost|money }}</span>
    </div>
    <div class="d-flex justify-content-between">
      <span>Total</span><span class="fw-semibold">{{ order.total|money }}</span>
    </div>

    {% if order.status == "paid" %}
      <div class="mt-2 small">
        {% if order.stripe_receipt_url %}
          <a href="{{ order.stripe_receipt_url }}" target="_blank" rel="noopener">View Stripe receipt</a>
          <a class="btn btn-outline-dark" href="{% url 'order_invoice' order.id %}">View Invoice</a>

          ·
        {% endif %}
        {% if order.paid_at %}Paid at {{ order.paid_at|date:"M j, Y H:i" }}{% endif %}
      </div>
    {% endif %}
  </div>

  {% if order.status == "pending" %}
  <div class="mt-3 d-flex gap-2">
    <a class="btn btn-dark" href="{% url 'create_checkout_session' order.id %}">Pay with Stripe (Test)</a>
  </div>
  {% endif %}

  <div class="mt-3">
    <a class="btn btn-dark" href="/shop/">Continue Shopping</a>
  </div>
</div>
{% endblock %}
